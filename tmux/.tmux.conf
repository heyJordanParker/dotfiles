# Terminal features & colors
set -gs terminal-features 'tmux-*:RGB,tmux-*:extkeys,tmux-*:hyperlinks'
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:RGB"
set-option -g focus-events on

# Ghostty setup
set -gs terminal-features 'xterm-ghostty:bpaste,ccolour,clipboard,cstyle,extkeys,focus,title,hyperlinks,RGB'
set -as terminal-features 'xterm-*:hyperlinks,RGB,extkeys'

# Mouse support with smoother scrolling
set -g mouse on
set -g allow-passthrough on
set -g @scroll-speed-num-lines-per-scroll 1
set -g @scroll-down-exit-copy-mode "on"
set -g @scroll-without-changing-pane "on"

# Cursor shape
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'

# Set Ctrl+S as prefix key
unbind C-b
set -g prefix C-s
bind-key C-s send-prefix

# Modern tmux settings
set -g base-index 1              # start indexing windows at 1 instead of 0
set -g detach-on-destroy off     # don't exit from tmux when closing a session
set -g escape-time 0             # zero-out escape time delay
set -g history-limit 1000000     # increase history size (from 2,000)
set -g renumber-windows on       # renumber all windows when any window is closed
set -g set-clipboard on          # use system clipboard
set -g display-time 1000         # show messages for 1 second


# --- POPUP BINDINGS (using tmux-toggle-term) ---

# Global Scratch (Alt + `) - Reset on Dir Change (1)
bind -n 'M-`' run-shell "~/.local/bin/tmux-toggle-term global-scratch '' '#{pane_current_path}' 1 >/dev/null 2>&1"

# VIM (Alt + v) - Keep Persistent (0) - Context handled by tmux-nvim wrapper
bind -n M-v run-shell "~/.local/bin/tmux-toggle-term nvim-scratch '~/.local/bin/tmux-nvim' '#{pane_current_path}' 0 >/dev/null 2>&1"

# LAZYGIT (Alt + g) - Reset on Dir Change (1)
bind -n M-g run-shell "~/.local/bin/tmux-toggle-term lazygit-popup 'lazygit' '#{pane_current_path}' 1 >/dev/null 2>&1"

# BTOP (Alt + Escape) - Keep Persistent (0)
bind -n M-Escape run-shell "~/.local/bin/tmux-toggle-term btop-popup 'btop' '#{pane_current_path}' 0 >/dev/null 2>&1"

# SPF (Alt + e) - Always Reset (2)
bind -n M-e run-shell "~/.local/bin/tmux-toggle-term spf-popup 'spf' '#{pane_current_path}' 2 >/dev/null 2>&1"

# SCROLLBACK (Alt + c) - Refresh on Open
bind -n M-c run-shell "~/.local/bin/tmux-toggle-term scrollback-popup '~/.tmux/scripts/view-scrollback.sh #{pane_id}' '#{pane_current_path}' 2 >/dev/null 2>&1"

# Prefix bindings (keep for compatibility)
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" lazygit
bind b display-popup -E -w 90% -h 90% btop
bind e display-popup -E -w 90% -h 90% -d "#{pane_current_path}" spf
bind ` display-popup -E -w 80% -h 80% -d "#{pane_current_path}"

# Better splitting (open in current directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Modern navigation (jkli layout) - with prefix
bind j select-pane -L
bind k select-pane -D
bind l select-pane -R
bind i select-pane -U

# Vim-aware keybindings: pass keys to vim/nvim/fzf when active
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

# Direct pane navigation (Alt + jkli) - vim-aware
bind -n M-j if-shell "$is_vim" 'send-keys M-j' 'select-pane -L'
bind -n M-k if-shell "$is_vim" 'send-keys M-k' 'select-pane -D'
bind -n M-l if-shell "$is_vim" 'send-keys M-l' 'select-pane -R'
bind -n M-i if-shell "$is_vim" 'send-keys M-i' 'select-pane -U'

# Pane resize (Alt + Shift + jkli) - vim-aware
bind -n M-J if-shell "$is_vim" 'send-keys M-J' 'resize-pane -L 5'
bind -n M-K if-shell "$is_vim" 'send-keys M-K' 'resize-pane -D 5'
bind -n M-L if-shell "$is_vim" 'send-keys M-L' 'resize-pane -R 5'
bind -n M-I if-shell "$is_vim" 'send-keys M-I' 'resize-pane -U 5'

# Pane create/split (Alt + Ctrl + jkli) - vim-aware
bind -n M-C-j if-shell "$is_vim" 'send-keys M-C-j' 'split-window -hb -c "#{pane_current_path}"'
bind -n M-C-k if-shell "$is_vim" 'send-keys M-C-k' 'split-window -v -c "#{pane_current_path}"'
bind -n M-C-l if-shell "$is_vim" 'send-keys M-C-l' 'split-window -h -c "#{pane_current_path}"'
bind -n M-C-i if-shell "$is_vim" 'send-keys M-C-i' 'split-window -vb -c "#{pane_current_path}"'

# Window select (Alt + 1-9)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Previous window (Alt + Tab)
bind -n M-Tab last-window

# Window navigation (Alt + [ / ])
bind -n M-[ previous-window
bind -n M-] next-window

# Copy pane working dir (Alt + Shift + c)
bind -n M-C run-shell "tmux display-message -p '#{pane_current_path}' | tr -d '\n' | pbcopy && tmux display-message 'Copied: #{pane_current_path}'"


# Modern window/pane management
bind t new-window -c "#{pane_current_path}"
bind w kill-pane
bind W kill-window
bind ] next-window
bind [ previous-window
bind Tab last-window

# Session management
bind n new-session
bind Q kill-session
bind C-f command-prompt { find-window -Z "%%" }

# Custom key bindings
bind-key -n S-Enter send-keys M-Enter

# Copy mode entry
bind c copy-mode                    # prefix + c = enter copy mode
bind / copy-mode \; send-keys ?     # prefix + / = search up (backwards)
bind ? copy-mode \; send-keys /     # prefix + ? = search down (forwards)

# Choose tree (session/window browser) on prefix + Space (popup)
bind-key Space display-popup -E -w 60% -h 60% "tmux choose-tree -Zs"

# Use vi mode keys for copy mode
setw -g mode-keys vi


# Rename window/session
bind r command-prompt -I "#W" "rename-window '%%'"
bind R command-prompt -I "#S" "rename-session '%%'"

# Reload config and install plugins
unbind C
bind C refresh-client \; run-shell "~/.tmux/plugins/tpm/bin/clean_plugins >/dev/null 2>&1" \; source-file ~/.tmux.conf \; run-shell "~/.tmux/plugins/tpm/bin/install_plugins >/dev/null 2>&1" \; display-message -d 1000 "Tmux config reloaded & plugins refreshed."


# Plugin manager
# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'catppuccin/tmux'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'tmux-plugins/tmux-open'

# tmux-fzf configuration
set -g @tmux-fzf-launch-key 'F'
set -g @tmux-fzf-options "-p -w 70% -h 50%"

# tmux-resurrect configuration
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# tmux-continuum configuration
set -g @continuum-restore 'on'

# extrakto configuration
set -g @extrakto_key 'x'
set -g @extrakto_filter_order "line word path url"
set -g @extrakto_filter_key "ctrl-l"
set -g @extrakto_split_size '12'

# tmux-open configuration - remap to Shift+Enter
set -g @open 'S-Enter'

# tmux-fingers configuration
set -g @fingers-key 'f'

# Configure Catppuccin
set -g @catppuccin_flavor "mocha"
set -g @catppuccin_status_background "none"
set -g @catppuccin_window_status_style "none"
set -g @catppuccin_pane_status_enabled "off"
set -g @catppuccin_pane_border_status "off"



# status left look and feel
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold]  #S },#{#[bg=default,fg=#{@thm_green}]  #S }}"
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=default,fg=#{@thm_blue}]  #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=default,fg=#{@thm_maroon}]  #{pane_current_command} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]#{?window_zoomed_flag,│,}"
set -ga status-left "#[bg=default,fg=#{@thm_yellow}]#{?window_zoomed_flag,  zoom ,}"

# status right look and feel
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#[bg=#{@thm_bg},fg=#{@thm_blue}] 󰭦 %Y-%m-%d 󰅐 %H:%M "

# bootstrap tpm
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# Configure Tmux
set -g status-position top
set -g status-style "bg=#{@thm_bg}"
set -g status-justify "absolute-centre"

# pane border look and feel
setw -g pane-border-status top
setw -g pane-border-format "#{?#{||:#{==:#{pane_current_command},zsh},#(test -f /tmp/claude-waiting-#{pane_id} && echo 1)},*,}"
setw -g pane-active-border-style "bg=#{@thm_bg},fg=#{@thm_overlay_0}"
setw -g pane-border-style "bg=#{@thm_bg},fg=#{@thm_surface_0}"
setw -g pane-border-lines single

# window look and feel
set -wg automatic-rename on
set -g automatic-rename-format "Window"

set -g window-status-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-style "bg=#{@thm_bg},fg=#{@thm_rosewater}"
set -g window-status-last-style "bg=#{@thm_bg},fg=#{@thm_peach}"
set -g window-status-activity-style "bg=#{@thm_red},fg=#{@thm_bg}"
set -g window-status-bell-style "bg=#{@thm_red},fg=#{@thm_bg},bold"
set -gF window-status-separator "#[bg=#{@thm_bg},fg=#{@thm_overlay_0}]│"

set -g window-status-current-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-current-style "bg=#{@thm_peach},fg=#{@thm_bg},bold"

# Copy mode vi bindings (jkli layout)
bind-key -T copy-mode-vi j send-keys -X cursor-left
bind-key -T copy-mode-vi k send-keys -X cursor-down
bind-key -T copy-mode-vi l send-keys -X cursor-right
bind-key -T copy-mode-vi i send-keys -X cursor-up

bind-key -T copy-mode-vi h send-keys -X previous-word
bind-key -T copy-mode-vi ';' send-keys -X next-word

bind-key -T copy-mode-vi u send-keys -X start-of-line
bind-key -T copy-mode-vi o send-keys -X end-of-line

bind-key -T copy-mode-vi U send-keys -X history-top
bind-key -T copy-mode-vi O send-keys -X history-bottom

bind-key -T copy-mode-vi C-u send-keys -X halfpage-up
bind-key -T copy-mode-vi C-d send-keys -X halfpage-down

bind-key -T copy-mode-vi '[' send-keys -X search-reverse
bind-key -T copy-mode-vi ']' send-keys -X search-again

bind-key -T copy-mode-vi Space send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"

bind-key -T copy-mode-vi Escape send-keys -X cancel
bind-key -T copy-mode-vi q send-keys -X cancel

# Override TPM bindings - must come after TPM load
unbind I
bind J split-window -hb -c "#{pane_current_path}"
bind K split-window -v -c "#{pane_current_path}"
bind L split-window -h -c "#{pane_current_path}"
bind I split-window -vb -c "#{pane_current_path}"


# ==========================================
# Custom Styling (Transparency & Layout)
# ==========================================

# Status Bar Position & Style
set -g status-position top
set -g status-style "bg=default"
set -g status-justify "absolute-centre"

# Pane Borders
setw -g pane-border-status top
setw -g pane-border-format ""
setw -g pane-active-border-style "bg=default,fg=#{@thm_overlay_0}"
setw -g pane-border-style "bg=default,fg=#{@thm_surface_0}"
setw -g pane-border-lines single

# Window Look & Feel
set -wg automatic-rename on
set -g automatic-rename-format "Window"

set -g window-status-format " #I#{?#{!=:#{window_name},Window},: #W,}#(bash ~/.tmux/scripts/window-waiting.sh #{window_id}) "
set -g window-status-style "bg=default,fg=#{@thm_rosewater}"
set -g window-status-last-style "bg=default,fg=#{@thm_peach}"
set -g window-status-activity-style "bg=#{@thm_red},fg=#{@thm_bg}"
set -g window-status-bell-style "bg=#{@thm_red},fg=#{@thm_bg},bold"
set -gF window-status-separator "#[bg=default,fg=#{@thm_overlay_0}]│"

set -g window-status-current-format " #I#{?#{!=:#{window_name},Window},: #W,} "
set -g window-status-current-style "bg=#{@thm_peach},fg=#{@thm_bg},bold"

# Status Left
set -g status-left-length 100
set -g status-left ""
set -ga status-left "#{?client_prefix,#{#[bg=#{@thm_red},fg=#{@thm_bg},bold]  #S },#{#[bg=default,fg=#{@thm_green}]  #S }}"
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=default,fg=#{@thm_blue}]  #{=/-32/...:#{s|$USER|~|:#{b:pane_current_path}}} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]│"
set -ga status-left "#[bg=default,fg=#{@thm_maroon}]  #{pane_current_command} "
set -ga status-left "#[bg=default,fg=#{@thm_overlay_0},none]#{?window_zoomed_flag,│,}"
set -ga status-left "#[bg=default,fg=#{@thm_yellow}]#{?window_zoomed_flag,  zoom ,}"

# Status Right
set -g status-right-length 100
set -g status-right ""
set -ga status-right "#[bg=default,fg=#{@thm_blue}] 󰭦 %Y-%m-%d 󰅐 %H:%M "

# Ensure background is transparent (Final Override)
set -g status-bg default
set -g status-style bg=default

# Popups
set -g popup-style "bg=default,fg=#{@thm_fg}"
set -g popup-border-style "bg=default,fg=#{@thm_surface_1}"
set -g popup-border-lines rounded

# Hooks
set-hook -g after-select-window 'run-shell "bash ~/.tmux/scripts/clear-waiting.sh #{window_id}"'

