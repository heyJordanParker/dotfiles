# Terminal features & colors
set -gs terminal-features 'tmux-*:RGB,tmux-*:extkeys,tmux-*:hyperlinks'
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:RGB"
set-option -g focus-events on

# Ghostty setup
set -gs terminal-features 'xterm-ghostty:bpaste,ccolour,clipboard,cstyle,extkeys,focus,title,hyperlinks,RGB'
set -as terminal-features 'xterm-*:hyperlinks,RGB,extkeys'

# Mouse support with smoother scrolling
set -g mouse on
set -g allow-passthrough on
set -g @scroll-speed-num-lines-per-scroll 1
set -g @scroll-down-exit-copy-mode "on"
set -g @scroll-without-changing-pane "on"

# Cursor shape
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'

# Set Ctrl+S as prefix key
unbind C-b
set -g prefix C-s
bind-key C-s send-prefix

# Modern tmux settings
set -g base-index 1              # start indexing windows at 1 instead of 0
set -g detach-on-destroy off     # don't exit from tmux when closing a session
set -g escape-time 0             # zero-out escape time delay
set -g history-limit 1000000     # increase history size (from 2,000)
set -g renumber-windows on       # renumber all windows when any window is closed
set -g set-clipboard on          # use system clipboard
set -g status-position top
set -g status-style "bg=#1e1e2e"

# Pane borders
set -g pane-active-border-style 'fg=magenta,bg=default'
set -g pane-border-style 'fg=brightblack,bg=default'

# --- POPUP BINDINGS (using tmux-toggle-term) ---

# Global Scratch (Alt + `) - Reset on Dir Change (1)
bind -n 'M-`' run-shell "~/.local/bin/tmux-toggle-term global-scratch '' '#{pane_current_path}' 1"

# VIM (Alt + v) - Keep Persistent (0) - Context handled by tmux-nvim wrapper
bind -n M-v run-shell "~/.local/bin/tmux-toggle-term nvim-scratch '~/.local/bin/tmux-nvim' '#{pane_current_path}' 0"

# LAZYGIT (Alt + g) - Reset on Dir Change (1)
bind -n M-g run-shell "~/.local/bin/tmux-toggle-term lazygit-popup 'lazygit' '#{pane_current_path}' 1"

# BTOP (Alt + Escape) - Keep Persistent (0)
bind -n M-Escape run-shell "~/.local/bin/tmux-toggle-term btop-popup 'btop' '#{pane_current_path}' 0"

# SPF (Alt + e) - Reset on Dir Change (1)
bind -n M-e run-shell "~/.local/bin/tmux-toggle-term spf-popup 'spf' '#{pane_current_path}' 1"

# Prefix bindings (keep for compatibility)
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" lazygit
bind b display-popup -E -w 90% -h 90% btop
bind e display-popup -E -w 90% -h 90% -d "#{pane_current_path}" spf
bind ` display-popup -E -w 80% -h 80% -d "#{pane_current_path}"
bind y run-shell "~/.tmux/scripts/toggle-scrollback.sh"

# Better splitting (open in current directory)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Modern navigation (jkli layout)
bind j select-pane -L
bind k select-pane -D
bind l select-pane -R
bind i select-pane -U


# Modern window/pane management
bind t new-window -c "#{pane_current_path}"
bind w kill-pane
bind W kill-window
bind ] next-window
bind [ previous-window
bind Tab last-window

# Session management
bind n new-session
bind Q kill-session
bind C-f command-prompt { find-window -Z "%%" }

# Custom key bindings
bind-key -n S-Enter send-keys M-Enter

# Copy mode search
bind / copy-mode \; send-key /

# Choose tree (session/window browser) on prefix + Space (popup)
bind-key Space display-popup -E -w 60% -h 60% "tmux choose-tree -Zs"

# Use emacs mode keys for copy mode
setw -g mode-keys emacs

# Copy mode navigation (jkli layout)
bind-key -T copy-mode j send-keys -X cursor-left
bind-key -T copy-mode k send-keys -X cursor-down
bind-key -T copy-mode l send-keys -X cursor-right
bind-key -T copy-mode i send-keys -X cursor-up


# Ensure escape exits copy mode
bind-key -T copy-mode Escape send-keys -X cancel

# Rename window/session
bind r command-prompt -I "#W" "rename-window '%%'"
bind R command-prompt -I "#S" "rename-session '%%'"

# Reload config and install plugins
unbind C
bind C refresh-client \; run-shell "~/.tmux/plugins/tpm/bin/clean_plugins >/dev/null 2>&1" \; source-file ~/.tmux.conf \; run-shell "~/.tmux/plugins/tpm/bin/install_plugins >/dev/null 2>&1" \; display-message -d 1000 "Tmux config reloaded & plugins refreshed."


# Plugin manager
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'nhdaly/tmux-better-mouse-mode'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'omerxx/catppuccin-tmux'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'tmux-plugins/tmux-open'
# set -g @plugin 'Morantron/tmux-fingers'

# tmux-fzf configuration
set -g @tmux-fzf-launch-key 'F'
set -g @tmux-fzf-options "-p -w 70% -h 50%"

# tmux-resurrect configuration
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# tmux-continuum configuration
set -g @continuum-restore 'on'

# extrakto configuration
set -g @extrakto_key 'x'
set -g @extrakto_filter_order "line word path url"
set -g @extrakto_filter_key "ctrl-l"
set -g @extrakto_split_size '12'

# tmux-open configuration - remap to Shift+Enter
set -g @open 'S-Enter'

# tmux-fingers configuration
set -g @fingers-key 'f'

# Catppuccin flavor
set -g @catppuccin_flavour 'mocha'
set -g @catppuccin_window_status_style 'rounded'

# Catppuccin theme config - exact copy from the original config
set -g @catppuccin_window_left_separator ""
set -g @catppuccin_window_right_separator " "
set -g @catppuccin_window_middle_separator " █"
set -g @catppuccin_window_number_position "right"
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_window_current_text "#W#{?window_zoomed_flag,(),}"
set -g @catppuccin_status_modules_right "directory date_time"
set -g @catppuccin_status_modules_left "session"
set -g @catppuccin_status_left_separator  " "
set -g @catppuccin_status_right_separator " "
set -g @catppuccin_status_right_separator_inverse "no"
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"
set -g @catppuccin_directory_text "#{b:pane_current_path}"
set -g @catppuccin_meetings_text "#($HOME/.config/tmux/scripts/cal.sh)"
set -g @catppuccin_date_time_text "%H:%M"

run '~/.tmux/plugins/tpm/tpm'

# Copy mode navigation (after plugin load)
bind-key -T copy-mode h send-keys -X previous-word
bind-key -T copy-mode \; send-keys -X next-word-end
bind-key -T copy-mode u send-keys -X start-of-line
unbind-key -T copy-mode o
bind-key -T copy-mode o send-keys -X end-of-line
bind-key -T copy-mode Space send-keys -X begin-selection

# Copy mode scrolling
bind-key -T copy-mode U send-keys -X halfpage-up
bind-key -T copy-mode O send-keys -X halfpage-down

# Copy mode selection
bind-key -T copy-mode Enter send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"

# Override TPM bindings - must come after TPM load
unbind I
bind J split-window -hb -c "#{pane_current_path}"
bind K split-window -v -c "#{pane_current_path}"
bind L split-window -h -c "#{pane_current_path}"
bind I split-window -vb -c "#{pane_current_path}"

