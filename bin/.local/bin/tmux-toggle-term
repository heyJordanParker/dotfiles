#!/bin/bash

SESSION_NAME="$1"
COMMAND="${2:-zsh}"
WORKDIR="${3:-$(pwd)}"
RESET_ON_DIR_CHANGE="${4:-0}"

POPUP_SOCKET="popup"
TMUX_POPUP="tmux -L $POPUP_SOCKET"

# Detach if inside this popup session (pattern: */popup,* in TMUX env)
if [[ "$TMUX" == */popup,* ]]; then
    $TMUX_POPUP detach-client
    exit 0
fi

# Initialize popup server if not running
$TMUX_POPUP start-server 2>/dev/null

# Mode 1: Reset if CWD changed
if [ "$RESET_ON_DIR_CHANGE" -eq 1 ] && $TMUX_POPUP has-session -t "$SESSION_NAME" 2>/dev/null; then
    SESSION_CWD=$($TMUX_POPUP list-panes -t "$SESSION_NAME" -F "#{pane_current_path}" | head -n 1)
    [ "$SESSION_CWD" != "$WORKDIR" ] && $TMUX_POPUP kill-session -t "$SESSION_NAME"
fi

# Mode 2: Always Reset
if [ "$RESET_ON_DIR_CHANGE" -eq 2 ] && $TMUX_POPUP has-session -t "$SESSION_NAME" 2>/dev/null; then
    $TMUX_POPUP kill-session -t "$SESSION_NAME"
fi

# Create session if needed
if ! $TMUX_POPUP has-session -t "$SESSION_NAME" 2>/dev/null; then
    $TMUX_POPUP new-session -d -s "$SESSION_NAME" -c "$WORKDIR" "$COMMAND"
    $TMUX_POPUP set-option -t "$SESSION_NAME" status off
    $TMUX_POPUP set-option -t "$SESSION_NAME" pane-border-status off
    $TMUX_POPUP set-option -t "$SESSION_NAME" detach-on-destroy on
fi

# Display popup (runs from main tmux, content from popup server)
tmux display-popup -d "$WORKDIR" -xC -yC -w 80% -h 80% \
    -E "$TMUX_POPUP attach-session -t $SESSION_NAME || exit 0"
